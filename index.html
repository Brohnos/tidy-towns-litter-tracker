<!DOCTYPE html>
<html>
<head>
    <title>Tidy Towns Trash Tracker</title>

<style>
    #map {
        height: 100vh; /* This makes the map take up the full height of the page */
        width: 100%; /* This makes the map take up the full width of the page */
    }
</style>

</head>
<body>
    <!-- We'll add our map here later -->
    <div id="map"></div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <script>
const firebaseConfig = {
  apiKey: "AIzaSyCOEpz-LCmMsvoDOkH6CdqUsAfh42DTmug",
  authDomain: "tidy-towns-litter-tracker.firebaseapp.com",
  databaseURL: "https://tidy-towns-litter-tracker-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tidy-towns-litter-tracker",
  storageBucket: "tidy-towns-litter-tracker.appspot.com",
  messagingSenderId: "532639980959",
  appId: "1:532639980959:web:a62234e579947ce5a831aa",
  measurementId: "G-SZZW59VS4Q"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Get a reference to the Firestore database
    let db = firebase.firestore();

    // Create a new marker
function createMarker(lat, lng, docId, map, db, openInfoWindow = false) {
    let marker = new google.maps.Marker({
        position: new google.maps.LatLng(lat, lng),
        map: map
    });

    let infoWindow = new google.maps.InfoWindow({
        content: "<p>Leave comment</p><textarea id='input-comment-" + docId + "'></textarea><button id='save-" + docId + "'>Save</button><button id='delete-" + docId + "'>Delete</button><button id='cancel-" + docId + "'>Cancel</button><p>Comments</p><textarea id='display-comment-" + docId + "' readonly></textarea>"
    });

    marker.addListener("click", () => {
        infoWindow.open(map, marker);

        setTimeout(() => { // Ensure the content is loaded before we try to add event listeners
            document.getElementById('save-' + docId).addEventListener('click', () => {
                let comment = document.getElementById('input-comment-' + docId).value;
                let existingComments = document.getElementById('display-comment-' + docId).value;
                let newComments = existingComments + "\n" + new Date().toLocaleString() + " - " + comment;
                db.collection("markers").doc(docId).update({
                    comment: newComments
                }).then(() => {
                    console.log("Document successfully updated!");
                    location.reload();
                }).catch((error) => {
                    console.error("Error updating document: ", error);
                });
            });

            document.getElementById('delete-' + docId).addEventListener('click', () => {
                db.collection("markers").doc(docId).delete().then(() => {
                    console.log("Document successfully deleted!");
                    location.reload();
                }).catch((error) => {
                    console.error("Error removing document: ", error);
                });
            });

            document.getElementById('cancel-' + docId).addEventListener('click', () => {
                db.collection("markers").doc(docId).delete().then(() => {
                    console.log("Marker cancelled!");
                    location.reload();
                }).catch((error) => {
                    console.error("Error removing document: ", error);
                });
            });
        }, 100);
    });

    if(openInfoWindow) {
        infoWindow.open(map, marker);
    }

    marker.infoWindow = infoWindow;

    return marker;
}

// Create a new map
function initMap() {
    var map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 52.260465, lng: -7.010256}, // Coordinates for Faithlegg
        zoom: 14,
        mapTypeId: 'satellite' // Set the map type to satellite
    });

    let markersMapping = {};

  db.collection("markers").onSnapshot((querySnapshot) => {
    querySnapshot.docChanges().forEach((change) => {
        let data = change.doc.data();
        let docId = change.doc.id;

        if (change.type === "added") {
            let marker = createMarker(data.lat, data.lng, docId, map, db);
            markersMapping[docId] = marker;
        } else if (change.type === "modified") {
            let marker = markersMapping[docId];
            let infoWindow = marker.infoWindow;
            infoWindow.setContent("<p>Leave comment</p><textarea id='input-comment-" + docId + "'></textarea><button id='save-" + docId + "'>Save</button><button id='delete-" + docId + "'>Delete</button><button id='cancel-" + docId + "'>Cancel</button><p>Comments</p><textarea id='display-comment-" + docId + "' readonly>" + (data.comment || '') + "</textarea>");

            marker.addListener("click", () => {
                setTimeout(() => { // Ensure the content is loaded before we try to add event listeners
                    document.getElementById('save-' + docId).addEventListener('click', () => {
                        let comment = document.getElementById('input-comment-' + docId).value;
                        let existingComments = document.getElementById('display-comment-' + docId).value;
                        let newComments = existingComments + "\n" + new Date().toLocaleString() + " - " + comment;
                        db.collection("markers").doc(docId).update({
                            comment: newComments
                        }).then(() => {
                            console.log("Document successfully updated!");
                            location.reload();
                        }).catch((error) => {
                            console.error("Error updating document: ", error);
                        });
                    });

                    document.getElementById('delete-' + docId).addEventListener('click', () => {
                        db.collection("markers").doc(docId).delete().then(() => {
                            console.log("Document successfully deleted!");
                            location.reload();
                        }).catch((error) => {
                            console.error("Error removing document: ", error);
                        });
                    });

                    document.getElementById('cancel-' + docId).addEventListener('click', () => {
                        db.collection("markers").doc(docId).delete().then(() => {
                            console.log("Marker cancelled!");
                            location.reload();
                        }).catch((error) => {
                            console.error("Error removing document: ", error);
                        });
                    });
                }, 100);
            });

            if (!infoWindow.getMap() || infoWindow.getMap() === null) {
                infoWindow.open(map, marker);
            }
        } else if (change.type === "removed") {
            let marker = markersMapping[docId];
            marker.setMap(null);
            delete markersMapping[docId];
        }
    });
});

            if (!infoWindow.getMap() || infoWindow.getMap() === null) {
                infoWindow.open(map, marker);
            }
        } else if (change.type === "removed") {
            let marker = markersMapping[docId];
            marker.setMap(null);
            delete markersMapping[docId];
        }
    });
});

    </script>

    <!-- Google Maps JavaScript API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCOEpz-LCmMsvoDOkH6CdqUsAfh42DTmug&callback=initMap"></script>

</body>
</html>

               
